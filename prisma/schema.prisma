// ========================================
// VOCAID B2C PRUNED SCHEMA
// This schema contains only the models needed for B2C Interview Practice
// Models marked for legacy are NOT included here
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum UserType {
  PERSONAL  // B2C self-service users (individuals practicing interviews)
}

enum ConsentSource {
  FORM   // Custom sign-up form
  OAUTH  // OAuth provider (Google, Apple, Microsoft, LinkedIn)
}

enum ResumeSource {
  UPLOAD    // Manually uploaded by user
  LINKEDIN  // Imported from LinkedIn
  GENERATED // Generated from form input
}

enum ResumeScoreProvider {
  AFFINDA                    // Affinda ATS parser/matcher
  TEXTKERNEL                 // Textkernel parser
  INTERNAL_KEYWORD           // Internal keyword matching
  INTERNAL_INTERVIEW_OUTCOME // Derived from interview performance
}

enum InterviewStatus {
  PENDING     // Interview created but not started
  IN_PROGRESS // Interview currently in progress
  COMPLETED   // Interview completed successfully
  FAILED      // Interview failed (technical error)
  CANCELLED   // Interview cancelled by user
}

enum InterviewEndReason {
  COMPLETED           // Normal completion
  USER_HANGUP         // User ended call
  TIME_LIMIT          // Maximum duration reached
  INCOMPATIBILITY     // Resume/job mismatch detected
  TECHNICAL_ERROR     // WebSocket or API error
  SILENCE_TIMEOUT     // User stopped responding
  AGENT_ERROR         // LLM or TTS error
}

enum PaymentStatus {
  PENDING     // Payment initiated
  APPROVED    // Payment successful
  REJECTED    // Payment rejected
  CANCELLED   // Payment cancelled
  REFUNDED    // Payment refunded
  IN_PROCESS  // Payment being processed
}

enum PaymentProvider {
  MERCADOPAGO // Mercado Pago (LATAM primary)
  PAYPAL      // PayPal (Global)
  STRIPE      // Stripe (Future)
}

enum CreditTransactionType {
  PURCHASE    // Credits purchased via payment
  GRANT       // Free credits (signup bonus, promo)
  SPEND       // Credits spent on interview
  REFUND      // Credits refunded (payment refund)
  RESTORE     // Credits restored (early quit)
  ADMIN       // Manual adjustment by admin
  PROMO       // Promotional credits
  REFERRAL    // Referral bonus credits
  EXPIRE      // Credits expired (if implementing expiry)
}

enum EmailSendStatus {
  PENDING     // Email not yet sent
  SENDING     // Email currently being sent (in progress)
  SENT        // Email sent successfully
  FAILED      // Email failed to send
  SKIPPED     // Email skipped (user opted out)
}

enum TransactionalEmailType {
  WELCOME                    // Registration confirmation email
  CREDITS_PURCHASE_RECEIPT   // Purchase confirmation with receipt
  PASSWORD_RESET             // Password reset instructions
  EMAIL_VERIFICATION         // Email verification link
  INTERVIEW_REMINDER         // Reminder about scheduled/unfinished interview
  LOW_CREDITS_WARNING        // Warning when credits are running low
  INTERVIEW_COMPLETE         // Interview completed summary
}

enum EmailProvider {
  RESEND      // Resend email service
}

// ========================================
// USER MODEL
// ========================================
model User {
  id                  String    @id @default(uuid()) @db.Uuid
  email               String    @unique
  googleId            String?   @unique @map("google_id")
  firstName           String?   @map("first_name")
  lastName            String?   @map("last_name")
  imageUrl            String?   @map("image_url")
  passwordHash        String?   @map("password_hash")
  emailVerified       Boolean   @default(false) @map("email_verified")
  emailVerifiedAt     DateTime? @map("email_verified_at")
  credits             Int       @default(0)
  isActive            Boolean   @default(true) @map("is_active")
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // User Type & Country (B2C Brazil-only for now)
  userType            UserType  @default(PERSONAL) @map("user_type")
  countryCode         String    @default("BR") @map("country_code") @db.VarChar(2)

  // Localization & Onboarding Metadata
  preferredLanguage     String?   @map("preferred_language") @db.VarChar(10)
  registrationRegion    String?   @map("registration_region") @db.VarChar(10)
  registrationCountry   String?   @map("registration_country") @db.VarChar(2)
  initialIp             String?   @map("initial_ip") @db.VarChar(45)
  onboardingComplete    Boolean   @default(false) @map("onboarding_complete")
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  
  // Role & Seniority
  currentRole         String?   @map("current_role") @db.VarChar(50)
  currentSeniority    String?   @map("current_seniority") @db.VarChar(30)
  
  // Auth providers used (google, apple, microsoft, linkedin, email, phone)
  authProviders       String[]  @map("auth_providers") @db.VarChar(30)
  lastAuthProvider    String?   @map("last_auth_provider") @db.VarChar(30)
  
  // Phone verification (Twilio)
  phoneNumber         String?   @map("phone_number") @db.VarChar(20)
  phoneVerified       Boolean   @default(false) @map("phone_verified")
  phoneVerifiedAt     DateTime? @map("phone_verified_at")

  // Relations
  sessions        Session[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  interviews      Interview[]
  feedbackDocuments FeedbackDocument[]
  payments        Payment[]
  scoreHistory    InterviewScoreHistory[]
  usageLogs       UsageLog[]
  resumeDocuments ResumeDocument[]
  chatSessions    ChatSession[]
  linkedInProfiles LinkedInProfile[]
  creditsWallet   CreditsWallet?
  creditLedger    CreditLedger[]
  transactionalEmails TransactionalEmail[]
  userConsent     UserConsent?
  performanceGoal PerformanceGoal?

  @@index([email])
  @@index([isActive])
  @@index([preferredLanguage])
  @@index([registrationRegion])
  @@index([currentRole])
  @@index([onboardingCompletedAt])
  @@index([userType])
  @@index([countryCode])
  @@index([phoneNumber])
  @@index([phoneVerified])
  @@map("users")
}

// ========================================
// PERFORMANCE GOAL MODEL
// Stores user's weekly practice targets for the Performance page
// ========================================
model PerformanceGoal {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @unique @map("user_id") @db.Uuid

  weeklyInterviewGoal Int     @default(3) @map("weekly_interview_goal")
  weeklyMinutesGoal   Int     @default(60) @map("weekly_minutes_goal")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("performance_goals")
}

// ========================================
// FIRST-PARTY AUTH MODELS
// ========================================

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash") @db.VarChar(64)

  expiresAt  DateTime  @map("expires_at")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.VarChar(500)
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model EmailVerificationToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash") @db.VarChar(64)

  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash") @db.VarChar(64)

  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  ipAddress String?   @map("ip_address") @db.VarChar(45)
  userAgent String?   @map("user_agent") @db.VarChar(500)
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

// ========================================
// CREDITS WALLET MODEL
// Single source of truth for user's credit balance
// ========================================
model CreditsWallet {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @unique @map("user_id") @db.Uuid
  
  balance         Int       @default(0)
  
  // Lifetime stats
  totalEarned     Int       @default(0) @map("total_earned")
  totalSpent      Int       @default(0) @map("total_spent")
  totalPurchased  Int       @default(0) @map("total_purchased")
  totalGranted    Int       @default(0) @map("total_granted")
  
  lastCreditAt    DateTime? @map("last_credit_at")
  lastDebitAt     DateTime? @map("last_debit_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([balance])
  @@map("credits_wallets")
}

// ========================================
// CREDIT LEDGER MODEL
// Immutable audit trail for all credit transactions
// ========================================
model CreditLedger {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  
  type            CreditTransactionType
  amount          Int
  balanceAfter    Int       @map("balance_after")
  
  referenceType   String?   @map("reference_type") @db.VarChar(50)
  referenceId     String?   @map("reference_id") @db.VarChar(255)
  
  description     String    @db.VarChar(255)
  metadata        Json?     @db.JsonB
  
  idempotencyKey  String?   @unique @map("idempotency_key") @db.VarChar(255)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("credit_ledger")
}

// ========================================
// RESUME DOCUMENT MODEL
// User's resume repository with version control
// ========================================
model ResumeDocument {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  
  source          ResumeSource @default(UPLOAD)
  
  // File metadata (actual file in Azure Blob Storage)
  fileName        String    @map("file_name") @db.VarChar(255)
  mimeType        String    @map("mime_type") @db.VarChar(100)
  fileSize        Int       @map("file_size")
  
  // Azure Blob Storage key (replaces base64Data)
  storageKey      String?   @map("storage_key") @db.VarChar(500)
  
  // Metadata
  title           String    @db.VarChar(255)
  description     String?   @db.Text
  tags            String[]  @default([])
  
  linkedInProfileUrl String? @map("linkedin_profile_url") @db.VarChar(500)
  
  // Parsed content
  parsedText      String?   @map("parsed_text") @db.Text
  parsedMetadata  Json?     @map("parsed_metadata") @db.JsonB
  
  // Version control
  version         Int       @default(1)
  parentVersionId String?   @map("parent_version_id") @db.Uuid
  isLatest        Boolean   @default(true) @map("is_latest")
  
  qualityScore    Int?      @map("quality_score")
  
  isActive        Boolean   @default(true) @map("is_active")
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  lastUsedAt      DateTime? @map("last_used_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentVersion   ResumeDocument? @relation("ResumeVersions", fields: [parentVersionId], references: [id])
  childVersions   ResumeDocument[] @relation("ResumeVersions")
  interviews      Interview[] @relation("ResumeInterviews")
  scores          ResumeScore[]
  
  @@index([userId])
  @@index([isPrimary])
  @@index([isActive, isLatest])
  @@index([tags])
  @@index([lastUsedAt])
  @@index([source])
  @@index([storageKey])
  @@map("resume_documents")
}

// ========================================
// RESUME SCORE MODEL
// Stores ATS-style scores per resume/role combination
// ========================================
model ResumeScore {
  id              String    @id @default(uuid()) @db.Uuid
  resumeId        String    @map("resume_id") @db.Uuid
  
  roleTitle       String    @map("role_title") @db.VarChar(255)
  
  score           Float     @db.DoublePrecision
  provider        ResumeScoreProvider
  breakdown       Json?     @db.JsonB
  
  computedAt      DateTime  @default(now()) @map("computed_at")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  resume          ResumeDocument @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  
  @@unique([resumeId, roleTitle, provider])
  @@index([resumeId])
  @@index([roleTitle])
  @@index([provider])
  @@index([score])
  @@map("resume_scores")
}

// ========================================
// USER CONSENT MODEL
// Tracks legal consent for Terms, Privacy, and Communications
// ========================================
model UserConsent {
  id                    String        @id @default(uuid()) @db.Uuid
  userId                String        @unique @map("user_id") @db.Uuid
  
  termsAcceptedAt       DateTime      @map("terms_accepted_at")
  privacyAcceptedAt     DateTime      @map("privacy_accepted_at")
  
  termsVersion          String        @map("terms_version") @db.VarChar(20)
  privacyVersion        String        @map("privacy_version") @db.VarChar(20)
  
  transactionalOptIn    Boolean       @default(true) @map("transactional_opt_in")
  marketingOptIn        Boolean       @default(false) @map("marketing_opt_in")
  marketingOptInAt      DateTime?     @map("marketing_opt_in_at")
  marketingVersion      String?       @map("marketing_version") @db.VarChar(20)
  
  ipAddress             String?       @map("ip_address") @db.VarChar(45)
  userAgent             String?       @map("user_agent") @db.Text
  source                ConsentSource @default(FORM)

  // LinkedIn consent + connection metadata
  linkedinConsentAt         DateTime? @map("linkedin_consent_at")
  linkedinConsentVersion    String?   @map("linkedin_consent_version") @db.VarChar(20)
  linkedinSectionsConsented String[]  @default([]) @map("linkedin_sections_consented") @db.VarChar(50)
  linkedinConnectedAt       DateTime? @map("linkedin_connected_at")
  linkedinMemberId          String?   @map("linkedin_member_id") @db.VarChar(100)
  
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")
  
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([termsAcceptedAt])
  @@index([privacyAcceptedAt])
  @@index([marketingOptIn])
  @@index([source])
  @@index([linkedinConsentAt])
  @@index([linkedinConnectedAt])
  @@index([linkedinMemberId])
  @@map("user_consents")
}

// ========================================
// INTERVIEW MODEL
// Stores interview sessions and their results
// ========================================
model Interview {
  id              String           @id @default(uuid()) @db.Uuid
  userId          String           @map("user_id") @db.Uuid
  retellCallId    String?          @unique @map("retell_call_id")
  
  jobTitle        String           @map("job_title")
  companyName     String           @map("company_name")
  jobDescription  String           @map("job_description") @db.Text
  
  roleCountryCode String?          @map("role_country_code") @db.VarChar(2)
  
  seniority       String?          @db.VarChar(30)
  language        String?          @db.VarChar(10)
  
  agentId         String?          @map("agent_id") @db.VarChar(100)
  voiceId         String?          @map("voice_id") @db.VarChar(100)
  resumeScoreAtSession Int?        @map("resume_score_at_session")
  
  // Resume: required; file stored in Azure Blob via ResumeDocument.storageKey
  resumeId        String           @map("resume_id") @db.Uuid

  // Feedback: created only after generation; PDF stored in Azure Blob
  feedbackDocumentId String?       @unique @map("feedback_document_id") @db.Uuid
  
  status          InterviewStatus  @default(PENDING)
  score           Float?           @db.DoublePrecision

  // Optional short summary stored directly on interview
  feedbackText    String?          @map("feedback_text") @db.Text
  
  callDuration    Int?             @map("call_duration")
  startedAt       DateTime?        @map("started_at")
  endedAt         DateTime?        @map("ended_at")
  
  transcript      String?          @db.Text
  
  sentimentScore  Float?           @map("sentiment_score") @db.DoublePrecision
  wpmAverage      Float?           @map("wpm_average") @db.DoublePrecision
  confidenceTimeline Json?         @map("confidence_timeline") @db.JsonB
  
  emailSentAt        DateTime?     @map("email_sent_at")
  emailSendStatus    EmailSendStatus @default(PENDING) @map("email_send_status")
  emailLastError     String?       @map("email_last_error") @db.Text
  emailIdempotencyKey String?      @unique @map("email_idempotency_key") @db.VarChar(255)
  emailMessageId     String?       @map("email_message_id") @db.VarChar(255)
  
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  resumeDocument  ResumeDocument   @relation("ResumeInterviews", fields: [resumeId], references: [id])
  feedbackDocument FeedbackDocument? @relation("InterviewFeedbackDocument", fields: [feedbackDocumentId], references: [id], onDelete: SetNull)
  metrics         InterviewMetric[]
  scoreHistory    InterviewScoreHistory[]
  transcriptSegments TranscriptSegment[]
  emailLogs       EmailLog[]
  session         InterviewSession?
  studyRecommendation StudyRecommendation?

  @@index([userId])
  @@index([retellCallId])
  @@index([status])
  @@index([createdAt])
  @@index([jobTitle])
  @@index([companyName])
  @@index([seniority])
  @@index([language])
  @@index([resumeId])
  @@index([feedbackDocumentId])
  @@index([emailSendStatus])
  @@index([roleCountryCode])
  @@index([userId, createdAt])
  @@index([userId, endedAt])
  @@map("interviews")
}

// ========================================
// FEEDBACK DOCUMENT MODEL (CANONICAL)
// Stores structured feedback JSON in DB + PDF key in Azure Blob
// ========================================
model FeedbackDocument {
  id            String   @id @default(uuid()) @db.Uuid
  interviewId   String   @unique @map("interview_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid

  // Structured feedback kept in DB
  contentJson   Json?    @map("content_json") @db.JsonB
  overallScore  Float?   @map("overall_score") @db.DoublePrecision
  schemaVersion String?  @map("schema_version") @db.VarChar(20)
  promptVersion String?  @map("prompt_version") @db.VarChar(50)
  model         String?  @db.VarChar(100)

  transcriptionText String? @map("transcription_text") @db.Text
  feedbackText      String? @map("feedback_text") @db.Text

  // Single blob key for feedback PDF
  pdfStorageKey String? @map("pdf_storage_key") @db.VarChar(500)

  generatedAt DateTime @map("generated_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interview Interview? @relation("InterviewFeedbackDocument")

  @@index([userId])
  @@index([generatedAt])
  @@index([pdfStorageKey])
  @@map("feedback_documents")
}

// ========================================
// PERFORMANCE CHAT MODELS
// ========================================
model ChatSession {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid

  roleFilter    String? @map("role_filter") @db.VarChar(100)
  companyFilter String? @map("company_filter") @db.VarChar(100)
  isActive      Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
  @@index([isActive])
  @@index([updatedAt])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String   @id @default(uuid()) @db.Uuid
  sessionId String   @map("session_id") @db.Uuid
  role      String   @db.VarChar(20)
  content   String   @db.Text
  metadata  Json?    @db.JsonB

  createdAt DateTime @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ========================================
// LINKEDIN PROFILE MODELS
// ========================================
model LinkedInProfile {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @unique @map("user_id") @db.Uuid

  linkedinMemberId String?  @map("linkedin_member_id") @db.VarChar(100)
  profileUrl       String?  @map("profile_url") @db.VarChar(500)

  name       String? @db.VarChar(255)
  email      String? @db.VarChar(255)
  pictureUrl String? @map("picture_url") @db.VarChar(500)
  headline   String? @db.Text

  rawSections Json?  @map("raw_sections") @db.JsonB
  source      String @db.VarChar(30)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileScores LinkedInProfileScore[]

  @@index([linkedinMemberId])
  @@map("linkedin_profiles")
}

model LinkedInProfileScore {
  id        String   @id @default(uuid()) @db.Uuid
  profileId String   @map("profile_id") @db.Uuid

  roleKey   String   @map("role_key") @db.VarChar(100)
  provider  ResumeScoreProvider
  score     Float    @db.DoublePrecision
  breakdown Json?    @db.JsonB

  computedAt DateTime @default(now()) @map("computed_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  profile LinkedInProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, roleKey, provider], name: "profileId_roleKey_provider")
  @@index([profileId])
  @@index([roleKey])
  @@index([computedAt])
  @@map("linkedin_profile_scores")
}

// ========================================
// INTERVIEW METRICS MODEL
// Stores detailed interview performance metrics
// ========================================
model InterviewMetric {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  category      String
  metricName    String    @map("metric_name")
  score         Float     @db.DoublePrecision
  maxScore      Float     @default(10) @map("max_score") @db.DoublePrecision
  feedback      String?   @db.Text
  
  createdAt     DateTime  @default(now()) @map("created_at")

  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
  @@index([category])
  @@map("interview_metrics")
}

// ========================================
// TRANSCRIPT SEGMENT MODEL
// Stores timestamped transcript segments for media sync
// ========================================
model TranscriptSegment {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  speaker       String
  content       String    @db.Text
  
  startTime     Float     @map("start_time") @db.DoublePrecision
  endTime       Float     @map("end_time") @db.DoublePrecision
  
  sentimentScore Float?   @map("sentiment_score") @db.DoublePrecision
  
  segmentIndex  Int       @map("segment_index")
  
  createdAt     DateTime  @default(now()) @map("created_at")

  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
  @@index([startTime])
  @@index([segmentIndex])
  @@map("transcript_segments")
}

// ========================================
// STUDY RECOMMENDATION MODEL
// AI-generated learning recommendations per interview
// ========================================
model StudyRecommendation {
  id            String    @id @default(uuid()) @db.Uuid
  interviewId   String    @unique @map("interview_id") @db.Uuid
  
  topics        Json      @db.JsonB
  weakAreas     Json      @map("weak_areas") @db.JsonB
  
  generatedAt   DateTime  @default(now()) @map("generated_at")
  
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  @@index([interviewId])
  @@map("study_recommendations")
}

// ========================================
// PAYMENT MODEL
// Stores payment transaction records
// ========================================
model Payment {
  id                  String        @id @default(uuid()) @db.Uuid
  userId              String        @map("user_id") @db.Uuid
  
  provider            PaymentProvider @default(MERCADOPAGO)
  
  mercadoPagoId       String?       @unique @map("mercadopago_id")
  preferenceId        String?       @map("preference_id")
  
  providerPaymentId   String?       @map("provider_payment_id") @db.VarChar(255)
  
  packageId           String        @map("package_id")
  packageName         String        @map("package_name")
  creditsAmount       Int           @map("credits_amount")
  
  amountUSD           Float         @map("amount_usd") @db.DoublePrecision
  amountBRL           Float         @map("amount_brl") @db.DoublePrecision
  currency            String?       @db.VarChar(3)
  exchangeRate        Float?        @map("exchange_rate") @db.DoublePrecision
  
  status              PaymentStatus @default(PENDING)
  statusDetail        String?       @map("status_detail")
  
  webhookIdempotencyKey String?     @unique @map("webhook_idempotency_key") @db.VarChar(255)
  webhookProcessedAt    DateTime?   @map("webhook_processed_at")
  
  paidAt              DateTime?     @map("paid_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mercadoPagoId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ========================================
// INTERVIEW SCORE HISTORY MODEL
// Historical score tracking by role and company for analytics
// ========================================
model InterviewScoreHistory {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  interviewId   String    @map("interview_id") @db.Uuid
  
  role          String
  company       String
  
  overallScore  Float     @map("overall_score") @db.DoublePrecision
  technicalScore Float?   @map("technical_score") @db.DoublePrecision
  communicationScore Float? @map("communication_score") @db.DoublePrecision
  confidenceScore Float?  @map("confidence_score") @db.DoublePrecision
  
  callDuration  Int?      @map("call_duration")
  
  createdAt     DateTime  @default(now()) @map("created_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([userId, role])
  @@index([userId, company])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([role])
  @@map("interview_score_history")
}

// ========================================
// USAGE LOG MODEL
// Tracks user activity for analytics and quota tracking
// ========================================
model UsageLog {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  
  eventType     String    @map("event_type")
  resourceType  String?   @map("resource_type") @db.VarChar(50)
  amount        Int       @default(0)
  interviewId   String?   @map("interview_id") @db.Uuid
  description   String?   @db.Text
  eventData     Json?     @map("event_data") @db.JsonB
  
  timestamp     DateTime  @default(now())
  createdAt     DateTime  @default(now()) @map("created_at")
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([userId, resourceType, createdAt])
  @@index([eventType, timestamp])
  @@index([timestamp])
  @@map("usage_logs")
}

// ========================================
// EMAIL LOG MODEL
// Audit trail for interview-related emails
// ========================================
model EmailLog {
  id              String          @id @default(uuid()) @db.Uuid
  interviewId     String          @map("interview_id") @db.Uuid
  
  toEmail         String          @map("to_email") @db.VarChar(255)
  subject         String          @db.VarChar(500)
  templateType    String          @map("template_type") @db.VarChar(50)
  
  status          EmailSendStatus @default(PENDING)
  messageId       String?         @map("message_id") @db.VarChar(255)
  errorMessage    String?         @map("error_message") @db.Text
  
  idempotencyKey  String?         @unique @map("idempotency_key") @db.VarChar(255)
  
  language        String?         @db.VarChar(10)
  hasAttachment   Boolean         @default(false) @map("has_attachment")
  attachmentSize  Int?            @map("attachment_size")
  
  sentAt          DateTime?       @map("sent_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  
  interview       Interview       @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  @@index([interviewId])
  @@index([status])
  @@index([toEmail])
  @@index([templateType])
  @@index([createdAt])
  @@map("email_logs")
}

// ========================================
// TRANSACTIONAL EMAIL MODEL
// Tracks transactional emails (welcome, purchase receipts)
// ========================================
model TransactionalEmail {
  id              String                    @id @default(uuid()) @db.Uuid
  userId          String?                   @map("user_id") @db.Uuid
  
  toEmail         String                    @map("to_email") @db.VarChar(255)
  emailType       TransactionalEmailType    @map("email_type")
  
  status          EmailSendStatus           @default(PENDING)
  provider        EmailProvider             @default(RESEND)
  providerMessageId String?                 @map("provider_message_id") @db.VarChar(255)
  
  idempotencyKey  String                    @unique @map("idempotency_key") @db.VarChar(255)
  
  payloadJson     Json?                     @map("payload_json") @db.JsonB
  errorJson       Json?                     @map("error_json") @db.JsonB
  retryCount      Int                       @default(0) @map("retry_count")
  
  language        String?                   @db.VarChar(10)
  
  sentAt          DateTime?                 @map("sent_at")
  createdAt       DateTime                  @default(now()) @map("created_at")
  updatedAt       DateTime                  @updatedAt @map("updated_at")
  
  user            User?                     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([emailType])
  @@index([status])
  @@index([toEmail])
  @@index([createdAt])
  @@map("transactional_emails")
}

// ========================================
// INTERVIEW SESSION MODEL
// Rich metrics logging for interview calls
// ========================================
model InterviewSession {
  id              String              @id @default(uuid()) @db.Uuid
  interviewId     String              @unique @map("interview_id") @db.Uuid
  
  retellCallId    String?             @map("retell_call_id") @db.VarChar(100)
  retellAgentId   String?             @map("retell_agent_id") @db.VarChar(100)
  
  language        String              @db.VarChar(10)
  roleTitle       String              @map("role_title") @db.VarChar(200)
  seniority       String?             @db.VarChar(30)
  roleCountry     String?             @map("role_country") @db.VarChar(2)
  
  callStartedAt       DateTime?       @map("call_started_at")
  firstAgentUtteranceAt DateTime?     @map("first_agent_utterance_at")
  callEndedAt         DateTime?       @map("call_ended_at")
  
  timeToFirstToken    Int?            @map("time_to_first_token")
  timeToFirstAudio    Int?            @map("time_to_first_audio")
  avgResponseLatency  Float?          @map("avg_response_latency") @db.DoublePrecision
  
  transcriptLength    Int?            @map("transcript_length")
  totalTurns          Int?            @map("total_turns")
  agentTurns          Int?            @map("agent_turns")
  userTurns           Int?            @map("user_turns")
  
  promptTokens        Int?            @map("prompt_tokens")
  completionTokens    Int?            @map("completion_tokens")
  totalTokens         Int?            @map("total_tokens")
  estimatedCostUsd    Float?          @map("estimated_cost_usd") @db.DoublePrecision
  
  llmModel            String?         @map("llm_model") @db.VarChar(100)
  llmProvider         String?         @map("llm_provider") @db.VarChar(50)
  
  endReason           InterviewEndReason? @map("end_reason")
  completionRate      Float?          @map("completion_rate") @db.DoublePrecision
  clarificationTurns  Int?            @map("clarification_turns")
  silenceCount        Int?            @map("silence_count")
  
  retellDurationSec   Int?            @map("retell_duration_sec")
  retellDisconnectReason String?      @map("retell_disconnect_reason") @db.VarChar(100)
  
  hasCustomPrompt     Boolean         @default(false) @map("has_custom_prompt")
  recruiterPromptLength Int?          @map("recruiter_prompt_length")
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  
  interview           Interview       @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  @@index([interviewId])
  @@index([retellCallId])
  @@index([language])
  @@index([roleTitle])
  @@index([callStartedAt])
  @@index([endReason])
  @@map("interview_sessions")
}
